<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSI NEXUS | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gold: #f0b90b; --bg: #0b0e11; --card: #1e2329; --green: #0ecb81; --red: #f6465d; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding-bottom: 50px; overflow-x: hidden; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--card); border-bottom: 1px solid #333; }
        .user-info { display: flex; align-items: center; gap: 8px; }
        .profile-pic { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--gold); }
        
        /* Notifications Bell */
        .notif-box { position: relative; margin: 0 10px; cursor: pointer; }
        .bell-icon { font-size: 20px; color: var(--gold); }
        .notif-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: red; border-radius: 50%; border: 1px solid var(--bg); }

        .wallet-btn { background: var(--gold); color: black; border: none; padding: 6px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }

        /* News Ticker (Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø±) */
        .news-ticker { background: #161a1e; color: var(--gold); padding: 5px 0; font-size: 0.8rem; border-bottom: 1px solid #333; overflow: hidden; white-space: nowrap; }
        .ticker-text { display: inline-block; animation: ticker 30s linear infinite; padding-left: 100%; }
        @keyframes ticker { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* Trading & Layout */
        #chart { width: 100%; height: 300px; }
        .trade-box { padding: 15px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #2b3139; color: white; text-align: center; box-sizing: border-box; }
        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .buy-btn { background: var(--green); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; }
        .sell-btn { background: var(--red); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; }

        /* Order Book */
        .order-book { margin-top: 15px; background: var(--card); border-radius: 10px; padding: 10px; border: 1px solid #333; }
        .order-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #2b3139; font-size: 0.8rem; }
        .close-x { background: #333; color: white; border: none; border-radius: 3px; padding: 2px 6px; }

        /* Wallet Popup */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--gold); z-index: 100; width: 280px; text-align: center; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99; }
        .active-mode { background: var(--gold); color: black !important; }
        .mode-switch button { background: #333; color: white; border: none; padding: 8px; width: 45%; border-radius: 5px; margin: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="user-info">
            <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="profile-pic">
            <span id="usernameDisplay">...</span>
        </div>
        
        <div class="notif-box" onclick="showLatestNews()">
            <span class="bell-icon">ğŸ””</span>
            <div class="notif-dot"></div>
        </div>

        <button class="wallet-btn" onclick="toggleWallet()">Ù…Ø­ÙØ¸ØªÙŠ</button>
    </div>

    <div class="news-ticker">
        <div class="ticker-text" id="newsContent">
            Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©... ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙŠØ¯Ø±Ø§Ù„ÙŠ Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ... ØªÙ‚Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©... Ø¥Ø·Ù„Ø§Ù‚ Ø®Ø¯Ù…Ø© ABSI NEXUS Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...
        </div>
    </div>

    <div id="chart"></div>

    <div class="trade-box">
        <input type="number" id="tradeAmount" value="100">
        <div class="btns">
            <button class="buy-btn" onclick="openTrade('buy')">Ø´Ø±Ø§Ø¡</button>
            <button class="sell-btn" onclick="openTrade('sell')">Ø¨ÙŠØ¹</button>
        </div>

        <div class="order-book">
            <div style="display: flex; justify-content: space-between; color: #848e9c; font-size: 0.7rem; margin-bottom: 5px;">
                <span>Ø§Ù„Ù†ÙˆØ¹</span><span>Ø§Ù„ÙƒÙ…ÙŠØ©</span><span>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</span><span>Ø¥ØºÙ„Ø§Ù‚</span>
            </div>
            <div id="ordersContainer"></div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleWallet()"></div>
    <div class="modal" id="walletModal">
        <h3>Ù…Ø­ÙØ¸Ø© ABSI</h3>
        <p>Ø§Ù„Ø±ØµÙŠØ¯: <span id="balanceDisplay">0.00$</span></p>
        <div class="mode-switch">
            <button id="realBtn" onclick="switchMode('real')">Ø­Ù‚ÙŠÙ‚ÙŠ</button>
            <button id="demoBtn" onclick="switchMode('demo')">ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
        </div>
        <button onclick="toggleWallet()" style="margin-top:15px; color:#848e9c; border:none; background:none;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://absinexus-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const urlParams = new URLSearchParams(window.location.search);
    const user = urlParams.get('user') || 'guest';
    document.getElementById('usernameDisplay').innerText = user;

    let currentBalance = 0;
    let mode = 'demo';
    let currentPrice = 0;
    let openTrades = [];

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø± ---
    function showLatestNews() {
        alert("ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³ÙˆÙ‚: Ø§Ù„Ø¨ØªÙƒÙˆÙŠÙ† ÙŠØ®ØªØ¨Ø± Ù…Ù†Ø§Ø·Ù‚ Ø¯Ø¹Ù… Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªØ´ÙŠØ± Ø¥Ù„Ù‰ ØªÙØ§Ø¤Ù„ ÙÙŠ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù†Ø§Ø´Ø¦Ø©.");
    }

    function updateMarketNews() {
        const news = [
            "ğŸ”¥ Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ø¨ØªÙƒÙˆÙŠÙ† Ù„Ø­Ø§Ø¬Ø² Ø§Ù„Ù€ 86,000$ ÙŠØ«ÙŠØ± Ø­Ù…Ø§Ø³ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†",
            "ğŸ“Š ØªÙ‚Ø±ÙŠØ±: ØªØ¯ÙÙ‚Ø§Øª Ù…Ø§Ù„ÙŠØ© Ø¶Ø®Ù…Ø© ØªØ¯Ø®Ù„ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù€ ETF Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©",
            "âš¡ Ø´Ø±ÙƒØ© ØªØ³Ù„Ø§ ØªØ¹Ù„Ù† Ø¹Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ø®ØµÙˆØµ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„ÙƒØ±ÙŠØ¨ØªÙˆ Ù‚Ø±ÙŠØ¨Ø§Ù‹",
            "ğŸŒ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø¢Ø³ÙŠÙˆÙŠØ© ØªÙØªØªØ­ Ø¹Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ù…Ù„Ø­ÙˆØ¸ Ø§Ù„ÙŠÙˆÙ…"
        ];
        document.getElementById('newsContent').innerText = news.join(" | ");
    }
    setInterval(updateMarketNews, 60000); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© ---
    function loadUserData() {
        db.ref('users/' + user).on('value', s => {
            const data = s.val();
            currentBalance = mode === 'demo' ? data.balance_demo : data.balance_real;
            document.getElementById('balanceDisplay').innerText = currentBalance.toFixed(2) + "$";
        });
    }

    function toggleWallet() {
        const m = document.getElementById('walletModal');
        const o = document.getElementById('overlay');
        const show = m.style.display !== 'block';
        m.style.display = show ? 'block' : 'none';
        o.style.display = show ? 'block' : 'none';
    }

    function switchMode(m) {
        mode = m;
        document.getElementById('realBtn').className = mode === 'real' ? 'active-mode' : '';
        document.getElementById('demoBtn').className = mode === 'demo' ? 'active-mode' : '';
        loadUserData();
    }

    // --- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙˆØ§Ù„ØªØ¯Ø§ÙˆÙ„ ---
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { backgroundColor: '#0b0e11', textColor: '#848e9c' },
        grid: { vertLines: { color: '#1e2329' }, horzLines: { color: '#1e2329' } },
        priceScale: { borderColor: '#333' },
        timeScale: { borderColor: '#333' }
    });
    const candleSeries = chart.addCandlestickSeries({ upColor: '#0ecb81', downColor: '#f6465d' });

    fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100')
        .then(r => r.json()).then(data => {
            const formatted = data.map(d => ({ time: d[0]/1000, open: +d[1], high: +d[2], low: +d[3], close: +d[4] }));
            candleSeries.setData(formatted);
            currentPrice = formatted[formatted.length-1].close;
        });

    const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');
    ws.onmessage = (e) => {
        const k = JSON.parse(e.data).k;
        currentPrice = parseFloat(k.c);
        candleSeries.update({ time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: currentPrice });
        updateTradesDisplay();
    };

    function openTrade(type) {
        const amt = parseFloat(document.getElementById('tradeAmount').value);
        if(amt > currentBalance) return alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ!");
        
        openTrades.push({ id: Date.now(), type, entryPrice: currentPrice, amount: amt });
        const key = mode === 'demo' ? 'balance_demo' : 'balance_real';
        db.ref('users/' + user).update({ [key]: currentBalance - amt });
    }

    function updateTradesDisplay() {
        const container = document.getElementById('ordersContainer');
        container.innerHTML = '';
        openTrades.forEach((t, i) => {
            let pnl = (t.type === 'buy') ? (currentPrice - t.entryPrice) * (t.amount/t.entryPrice) : (t.entryPrice - currentPrice) * (t.amount/t.entryPrice);
            container.innerHTML += `
                <div class="order-row">
                    <span style="color:${t.type==='buy'?'#0ecb81':'#f6465d'}">${t.type==='buy'?'Ø´Ø±Ø§Ø¡':'Ø¨ÙŠØ¹'}</span>
                    <span>${t.amount}$</span>
                    <span style="color:${pnl>=0?'#0ecb81':'#f6465d'}">${pnl.toFixed(2)}$</span>
                    <button class="close-x" onclick="closeTrade(${i}, ${pnl})">X</button>
                </div>`;
        });
    }

    function closeTrade(i, pnl) {
        const t = openTrades[i];
        const key = mode === 'demo' ? 'balance_demo' : 'balance_real';
        db.ref('users/' + user).once('value', s => {
            db.ref('users/' + user).update({ [key]: s.val()[key] + (t.amount + pnl) });
        });
        openTrades.splice(i, 1);
        updateTradesDisplay();
    }

    loadUserData();
    updateMarketNews();
</script>
</body>
</html>
