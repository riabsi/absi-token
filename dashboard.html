<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSI NEXUS | الدخول والأمان</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --gold: #f0b90b; --bg: #0b0e11; --card: #1e2329; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-card { background: var(--card); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid #333; text-align: center; }
        h2 { color: var(--gold); margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #2b3139; color: white; box-sizing: border-box; text-align: center; }
        button { width: 100%; padding: 15px; margin-top: 15px; border-radius: 8px; border: none; background: var(--gold); color: black; font-weight: bold; cursor: pointer; }
        .links { margin-top: 20px; font-size: 0.8rem; color: #848e9c; }
        .links span { color: var(--gold); cursor: pointer; text-decoration: underline; margin: 0 5px; }
    </style>
</head>
<body>

<div class="login-card">
    <h2>ABSI NEXUS</h2>
    <div id="auth-form">
        <input type="text" id="user" placeholder="اسم المستخدم">
        <input type="password" id="pass" placeholder="كلمة المرور">
        <div id="extra-fields" style="display: none;">
            <input type="email" id="recoveryEmail" placeholder="بريد الاسترداد (للأمان)">
        </div>
        <button id="mainBtn" onclick="handleAuth()">دخول</button>
    </div>
    
    <div class="links">
        <p id="toggleText">ليس لديك حساب؟ <span onclick="toggleMode()">إنشاء حساب جديد</span></p>
        <p id="forgotLink">نسيت كلمة المرور؟ <span onclick="forgotPass()">استعادة عبر البريد</span></p>
    </div>
</div>

<script>
    // 1. إعدادات Firebase
    const firebaseConfig = { databaseURL: "https://absinexus-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // 2. تفعيل EmailJS ببياناتك الحقيقية من الصور
    (function() { 
        emailjs.init("I7O-M98m-x4dW5R3t"); // Public Key من صورتك
    })(); 

    let isLogin = true;

    function toggleMode() {
        isLogin = !isLogin;
        document.getElementById('extra-fields').style.display = isLogin ? 'none' : 'block';
        document.getElementById('mainBtn').innerText = isLogin ? 'دخول' : 'تأكيد التسجيل';
    }

    function handleAuth() {
        const user = document.getElementById('user').value.trim();
        const pass = document.getElementById('pass').value.trim();
        const email = document.getElementById('recoveryEmail').value.trim().toLowerCase();

        if (isLogin) {
            db.ref('users/' + user).once('value', s => {
                if (s.exists() && s.val().password === pass) {
                    window.location.href = "dashboard.html?user=" + user;
                } else { alert("خطأ في البيانات"); }
            });
        } else {
            if (!email) return alert("البريد مطلوب!");
            db.ref('users/' + user).set({
                username: user, password: pass, recoveryEmail: email,
                balance_real: 0, balance_demo: 1000
            }).then(() => { alert("تم إنشاء الحساب!"); toggleMode(); });
        }
    }

    // 3. استعادة كلمة المرور باستخدام معرف الخدمة الجديد
    function forgotPass() {
        const emailInput = prompt("أدخل بريد الاسترداد المسجل:");
        if (!emailInput) return;
        const searchEmail = emailInput.trim().toLowerCase();

        db.ref('users').once('value', snapshot => {
            let foundUser = null;
            snapshot.forEach(child => {
                if (child.val().recoveryEmail === searchEmail) foundUser = child.val();
            });

            if (foundUser) {
                alert("تم التحقق! جاري الإرسال...");
                
                emailjs.send("service_782r24l", "template_5glwjdq", { // Service ID الجديد
                    to_email: searchEmail,
                    user_name: foundUser.username,
                    user_password: foundUser.password
                }).then(() => {
                    alert("تم إرسال بيانات الدخول إلى بريدك بنجاح!");
                }).catch(err => {
                    alert("فشل الإرسال، تأكد من إعدادات القالب.");
                });
            } else {
                alert("هذا البريد غير مسجل.");
            }
        });
    }
</script>
</body>
</html>
