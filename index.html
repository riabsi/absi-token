<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSI NEXUS | Login & Register</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0b0e11; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background-color: #1e2329; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; width: 350px; position: relative; }
        .lang-btn { position: absolute; top: 15px; left: 15px; background: #2b3139; color: #f0b90b; border: 1px solid #474d57; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        h2 { color: #f0b90b; margin-bottom: 25px; }
        .input-group { position: relative; width: 100%; margin: 10px 0; }
        input { width: 100%; padding: 14px; border-radius: 5px; border: 1px solid #474d57; background-color: #2b3139; color: white; box-sizing: border-box; outline: none; text-align: inherit; }
        .toggle-password { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #848e9c; }
        button#main-btn { width: 100%; padding: 14px; background-color: #f0b90b; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; font-size: 16px; color: #000; }
        .link { color: #f0b90b; cursor: pointer; font-size: 14px; margin-top: 15px; display: block; text-decoration: none; }
        .hr-line { border-top: 1px solid #474d57; margin: 25px 0; }
    </style>
</head>
<body>

    <div class="container">
        <button class="lang-btn" onclick="toggleLanguage()" id="lang-switcher">English</button>
        <h2 id="form-title">تسجيل الدخول</h2>
        
        <div class="input-group"><input type="text" id="username" placeholder="اسم المستخدم"></div>
        <div class="input-group" id="email-group" style="display:none;"><input type="email" id="useremail" placeholder="البريد الإلكتروني"></div>
        <div class="input-group">
            <input type="password" id="password" placeholder="كلمة المرور">
            <i class="fas fa-eye toggle-password" onclick="togglePasswordView()"></i>
        </div>
        
        <button id="main-btn" onclick="handleAction()">دخول</button>
        <a id="forget-link" class="link" onclick="recoverAccount()">نسيت كلمة المرور؟</a>
        <div class="hr-line"></div>
        <div id="toggle-section">
            <span id="txt-footer" style="font-size: 14px; color: #848e9c;">ليس لديك حساب؟</span>
            <a class="link" id="toggle-link" onclick="toggleForm()" style="display: inline; margin-right: 5px; font-weight: bold;">إنشاء حساب جديد</a>
        </div>
    </div>

    <script>
        // إعدادات Firebase
        const firebaseConfig = { databaseURL: "https://riabsi-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // إعدادات EmailJS
        emailjs.init("I7O-M98m-x4dW5R3t");

        let currentLang = 'ar';
        let isRegisterMode = false;

        const translations = {
            ar: { titleLogin: "تسجيل الدخول", titleReg: "إنشاء حساب جديد", userPlce: "اسم المستخدم", emailPlce: "البريد الإلكتروني", passPlce: "كلمة المرور", btnIn: "دخول", btnUp: "تسجيل الحساب", forgot: "نسيت كلمة المرور؟", footerNo: "ليس لديك حساب؟", footerYes: "لديك حساب بالفعل؟", linkReg: "إنشاء حساب جديد", linkLog: "سجل دخولك", switch: "English", direction: "rtl", msgSuccess: "تم الدخول بنجاح! جاري تحويلك..." },
            en: { titleLogin: "Login", titleReg: "Create New Account", userPlce: "Username", emailPlce: "Email Address", passPlce: "Password", btnIn: "Login", btnUp: "Register", forgot: "Forgot Password?", footerNo: "Don't have an account?", footerYes: "Already have an account?", linkReg: "Create Account", linkLog: "Login Now", switch: "العربية", direction: "ltr", msgSuccess: "Login Successful! Redirecting..." }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            updateUI();
        }

        function updateUI() {
            const t = translations[currentLang];
            document.getElementById('main-html').dir = t.direction;
            document.getElementById('lang-switcher').innerText = t.switch;
            document.getElementById('username').placeholder = t.userPlce;
            document.getElementById('useremail').placeholder = t.emailPlce;
            document.getElementById('password').placeholder = t.passPlce;
            document.getElementById('forget-link').innerText = t.forgot;
            document.getElementById('form-title').innerText = isRegisterMode ? t.titleReg : t.titleLogin;
            document.getElementById('main-btn').innerText = isRegisterMode ? t.btnUp : t.btnIn;
            document.getElementById('txt-footer').innerText = isRegisterMode ? t.footerYes : t.footerNo;
            document.getElementById('toggle-link').innerText = isRegisterMode ? t.linkLog : t.linkReg;
        }

        function togglePasswordView() {
            const p = document.getElementById('password');
            p.type = p.type === "password" ? "text" : "password";
        }

        function toggleForm() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('email-group').style.display = isRegisterMode ? "block" : "none";
            document.getElementById('forget-link').style.display = isRegisterMode ? "none" : "block";
            updateUI();
        }

        function handleAction() { if (isRegisterMode) register(); else login(); }

        function login() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            if(!user || !pass) return;

            db.ref('users/' + user).once('value', snapshot => {
                if (snapshot.exists() && snapshot.val().password === pass) {
                    alert(translations[currentLang].msgSuccess);
                    
                    // --- التعديل الجوهري هنا ---
                    // التوجيه للرابط الكامل للمنصة
                    window.location.href = "https://riabsi.github.io/absi-token/wallet.html";
                    
                } else {
                    alert(currentLang === 'ar' ? "بيانات الدخول خاطئة" : "Invalid Credentials");
                }
            });
        }

        function register() {
            const user = document.getElementById('username').value.trim();
            const email = document.getElementById('useremail').value.trim();
            const pass = document.getElementById('password').value.trim();
            if (!user || !email || !pass) return alert("Fill all fields");

            db.ref('users/' + user).set({ email, password: pass }).then(() => {
                alert(currentLang === 'ar' ? "تم التسجيل بنجاح!" : "Registered successfully!");
                toggleForm();
            });
        }

        function recoverAccount() {
            const email = prompt(currentLang === 'ar' ? "أدخل بريدك:" : "Enter Email:");
            if (!email) return;
            db.ref('users').once('value', snapshot => {
                let found = null;
                snapshot.forEach(c => { if(c.val().email === email) found = {n:c.key, p:c.val().password} });
                if(found) {
                    emailjs.send("service_vv75pdh", "template_5glwjdq", { to_email: email, user_name: found.n, user_password: found.p })
                    .then(() => alert("Sent!"), () => alert("Error"));
                } else { alert("Not found"); }
            });
        }
    </script>
</body>
</html>
