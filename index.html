<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ABSI NEXUS PRO</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --bg: #0b0e11; --panel: #1e2329; --gold: #f0b90b; --buy: #0ecb81; --sell: #f6465d; --text: #eaecef; --dim: #848e9c; }
        body { background: var(--bg); color: var(--text); margin: 0; font-family: sans-serif; height: 100vh; overflow: hidden; }
        
        .page { display: none; height: calc(100vh - 70px); overflow-y: auto; width: 100%; }
        .page.active { display: flex; flex-direction: column; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: #161a1e; display: flex; border-top: 1px solid #2b3139; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--dim); cursor: pointer; transition: 0.2s; font-size: 0.7rem; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--gold); }

        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--panel); padding: 30px; border-radius: 15px; border: 1px solid var(--gold); width: 300px; text-align: center; }
        
        /* زيادة الارتفاع قليلاً لاستيعاب المؤشرات الجديدة */
        #chart-zone { height: 50vh; background: #000; }
        
        .trade-zone { flex: 1; background: var(--panel); padding: 15px; border-top: 2px solid var(--gold); }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #2b3139; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        .empty-page { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--dim); font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="color:var(--gold)">ABSI NEXUS</h2>
            <input type="text" id="username" placeholder="اسم المستخدم">
            <input type="password" id="password" placeholder="كلمة المرور">
            <button onclick="handleAuth()" style="width:100%; padding:12px; background:var(--gold); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">دخول</button>
        </div>
    </div>

    <div id="main-container">
        <div id="page-home" class="page"><div class="empty-page">صفحة الرئيسية قريباً...</div></div>
        <div id="page-markets" class="page"><div class="empty-page">صفحة الأسواق قريباً...</div></div>

        <div id="page-trade" class="page active">
            <div style="background:#181a20; padding:10px 15px; display:flex; justify-content:space-between; align-items:center;">
                <select id="pairSelector" onchange="changePair(this.value)" style="background:none; color:var(--gold); border:none; font-weight:bold; outline:none;">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                </select>
                <span id="live-price" style="color:var(--gold); font-weight:bold;">0.00$</span>
            </div>
            
            <div id="chart-zone">
                <div id="tv_chart" style="height:100%;"></div>
            </div>

            <div class="trade-zone">
                <input type="number" id="trade-amt" placeholder="المبلغ USDT" value="10">
                <div style="display:flex; gap:10px;">
                    <button onclick="openTrade('BUY')" style="flex:1; background:var(--buy); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold;">شراء</button>
                    <button onclick="openTrade('SELL')" style="flex:1; background:var(--sell); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold;">بيع</button>
                </div>
                <div id="orders-container" style="margin-top:10px;"></div>
            </div>
        </div>

        <div id="page-futures" class="page" style="background:#0b0e11; color:#eaecef; font-family: sans-serif;">
    
    <style>
        .f-green { color: #0ecb81 !important; }
        .f-red { color: #f6465d !important; }
        .f-bg-green { background-color: #0ecb81 !important; }
        .f-bg-red { background-color: #f6465d !important; }
        .input-box { background: #1e2329; border: 1px solid #2b3139; border-radius: 4px; padding: 6px 10px; display: flex; justify-content: space-between; margin-bottom: 8px; }
        .input-box input { background: none; border: none; color: white; width: 60%; outline: none; font-size: 14px; }
        .pos-card { background: #1e2329; padding: 12px; border-bottom: 1px solid #2b3139; margin-bottom: 2px; }
        .tab-btn { padding: 10px; color: #848e9c; cursor: pointer; font-size: 13px; }
        .tab-btn.active { color: white; border-bottom: 2px solid #f0b90b; }
    </style>

    <div style="padding: 10px 15px; border-bottom: 1px solid #2b3139; display: flex; justify-content: space-between; align-items: center; background: #161a1e;">
        <div>
            <strong style="font-size:16px;">BTCUSDT</strong>
            <span style="background:#2b3139; color:#f0b90b; font-size:10px; padding:2px 5px; border-radius:3px; margin-right:5px;">20x</span>
        </div>
        <div style="text-align: right;">
            <div style="font-size:11px; color:#848e9c;">المتاح (USDT)</div>
            <div id="f-wallet-bal" style="font-weight:bold; color:white;">10000.00</div>
        </div>
    </div>

    <div style="display:flex; padding:10px; gap:12px;">
        <div style="flex: 1; font-family: monospace; font-size: 11px;">
            <div id="f-ob-red" style="height: 110px; overflow:hidden; display:flex; flex-direction:column-reverse; opacity:0.8;"></div>
            <div style="margin:8px 0; text-align:center; padding:5px; background: rgba(14, 203, 129, 0.1);">
                <span id="f-price-mid" class="f-green" style="font-size:16px; font-weight:bold;">98420.50</span>
            </div>
            <div id="f-ob-green" style="height: 110px; overflow:hidden; opacity:0.8;"></div>
        </div>

        <div style="flex: 1.3;">
            <div style="display:flex; background:#2b3139; border-radius:4px; margin-bottom:10px; overflow:hidden; height:32px;">
                <button id="btn-f-buy" onclick="setTradeSide('buy')" style="flex:1; background:#0ecb81; color:white; border:none; font-weight:bold;">شراء</button>
                <button id="btn-f-sell" onclick="setTradeSide('sell')" style="flex:1; background:none; color:#848e9c; border:none; font-weight:bold;">بيع</button>
            </div>

            <div class="input-box"><input type="number" id="f-entry-price" step="0.1"><span style="color:#848e9c; font-size:11px;">USDT</span></div>
            <div class="input-box"><input type="number" id="f-entry-qty" placeholder="الكمية" oninput="calcCost()"><span style="color:#848e9c; font-size:11px;">BTC</span></div>

            <div style="font-size:10px; color:#848e9c; margin: 5px 0; display:flex; justify-content:space-between;">
                <span>التكلفة:</span>
                <span><span id="f-cost-val">0.00</span> USDT</span>
            </div>

            <button id="f-btn-main" onclick="openNewPosition()" style="width:100%; padding:12px; background:#0ecb81; color:white; border:none; border-radius:4px; font-weight:bold; font-size:14px; margin-top:5px;">شراء / Long</button>
        </div>
    </div>

    <div style="flex:1; background:#161a1e; border-top: 5px solid #0b0e11;">
        <div style="display:flex; border-bottom:1px solid #2b3139;">
            <div class="tab-btn active">الصفقات (<span id="pos-count">0</span>)</div>
            <div class="tab-btn">طلبات مفتوحة</div>
        </div>
        
        <div id="positions-list" style="overflow-y:auto; height: 200px;">
            </div>
    </div>

    <script>
        let fWallet = 10000.00;
        let fCurrentPrice = 98420.50;
        let fSide = 'buy';
        let positions = [];

        // 1. محرك السعر المباشر
        function runFuturesEngine() {
            fCurrentPrice += (Math.random() - 0.5) * 6;
            document.getElementById('f-price-mid').innerText = fCurrentPrice.toFixed(2);
            document.getElementById('f-entry-price').value = fCurrentPrice.toFixed(2);
            
            updateOB();
            updatePnL();
        }
        setInterval(runFuturesEngine, 1000);

        function updateOB() {
            let rH = '', gH = '';
            for(let i=0; i<6; i++) {
                rH += `<div style="display:flex; justify-content:space-between;"><span class="f-red">${(fCurrentPrice + (i*2)).toFixed(1)}</span><span>${(Math.random()*0.5).toFixed(2)}</span></div>`;
                gH += `<div style="display:flex; justify-content:space-between;"><span class="f-green">${(fCurrentPrice - (i*2)).toFixed(1)}</span><span>${(Math.random()*0.5).toFixed(2)}</span></div>`;
            }
            document.getElementById('f-ob-red').innerHTML = rH;
            document.getElementById('f-ob-green').innerHTML = gH;
        }

        // 2. إدارة الواجهة
        function setTradeSide(side) {
            fSide = side;
            const b = document.getElementById('btn-f-buy'), s = document.getElementById('btn-f-sell'), m = document.getElementById('f-btn-main');
            if(side === 'buy') {
                b.style.background = '#0ecb81'; b.style.color = 'white'; s.style.background = 'none'; s.style.color = '#848e9c';
                m.style.background = '#0ecb81'; m.innerText = 'شراء / Long';
            } else {
                s.style.background = '#f6465d'; s.style.color = 'white'; b.style.background = 'none'; b.style.color = '#848e9c';
                m.style.background = '#f6465d'; m.innerText = 'بيع / Short';
            }
        }

        function calcCost() {
            let qty = document.getElementById('f-entry-qty').value || 0;
            let cost = (qty * fCurrentPrice) / 20; // رافعة 20
            document.getElementById('f-cost-val').innerText = cost.toFixed(2);
        }

        // 3. فتح وإغلاق الصفقات
        function openNewPosition() {
            let qty = parseFloat(document.getElementById('f-entry-qty').value);
            let cost = (qty * fCurrentPrice) / 20;

            if(!qty || qty <= 0) return alert("أدخل الكمية");
            if(cost > fWallet) return alert("الرصيد غير كافٍ");

            fWallet -= cost;
            document.getElementById('f-wallet-bal').innerText = fWallet.toFixed(2);

            let newPos = {
                id: Date.now(),
                pair: 'BTCUSDT 20x',
                side: fSide,
                entry: fCurrentPrice,
                qty: qty,
                margin: cost
            };
            positions.push(newPos);
            renderPositions();
            document.getElementById('f-entry-qty').value = '';
        }

        function renderPositions() {
            const list = document.getElementById('positions-list');
            document.getElementById('pos-count').innerText = positions.length;
            list.innerHTML = '';

            positions.forEach(p => {
                list.innerHTML += `
                    <div class="pos-card" id="pos-${p.id}">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; color:${p.side==='buy'?'#0ecb81':'#f6465d'}">${p.side.toUpperCase()} ${p.pair}</span>
                            <span id="pnl-${p.id}" style="font-weight:bold;">0.00 USDT</span>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; font-size:11px; color:#848e9c; gap:5px;">
                            <div>حجم المركز: <span style="color:white">${(p.qty * p.entry).toFixed(2)}</span></div>
                            <div>سعر الدخول: <span style="color:white">${p.entry.toFixed(2)}</span></div>
                            <div>الهامش: <span style="color:white">${p.margin.toFixed(2)}</span></div>
                            <button onclick="closePos(${p.id})" style="background:#2b3139; color:white; border:none; padding:4px; border-radius:3px; cursor:pointer;">إغلاق</button>
                        </div>
                    </div>
                `;
            });
        }

        function updatePnL() {
            positions.forEach(p => {
                let diff = fCurrentPrice - p.entry;
                if(p.side === 'sell') diff = p.entry - fCurrentPrice;
                let pnl = diff * p.qty;
                let pnlEl = document.getElementById(`pnl-${p.id}`);
                if(pnlEl) {
                    pnlEl.innerText = (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + " USDT";
                    pnlEl.className = pnl >= 0 ? 'f-green' : 'f-red';
                }
            });
        }

        function closePos(id) {
            let pIndex = positions.findIndex(x => x.id === id);
            if(pIndex > -1) {
                let p = positions[pIndex];
                let diff = fCurrentPrice - p.entry;
                if(p.side === 'sell') diff = p.entry - fCurrentPrice;
                let pnl = diff * p.qty;
                
                fWallet += (p.margin + pnl);
                document.getElementById('f-wallet-bal').innerText = fWallet.toFixed(2);
                
                positions.splice(pIndex, 1);
                renderPositions();
            }
        }
    </script>
        </div>
        <div id="page-assets" class="page"><div class="empty-page">صفحة الأصول والمحفظة قريباً...</div></div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item" onclick="showPage('page-home', this)"><i class="fas fa-home"></i><span>الرئيسية</span></div>
        <div class="nav-item" onclick="showPage('page-markets', this)"><i class="fas fa-chart-bar"></i><span>الأسواق</span></div>
        <div class="nav-item active" onclick="showPage('page-trade', this)"><i class="fas fa-exchange-alt"></i><span>التداول</span></div>
        <div class="nav-item" onclick="showPage('page-futures', this)"><i class="fas fa-bolt"></i><span>العقود</span></div>
        <div class="nav-item" onclick="showPage('page-assets', this)"><i class="fas fa-wallet"></i><span>الأصول</span></div>
    </nav>

    <script>
        // دالة تغيير العملة وتفعيل المؤشرات
        function changePair(pair) {
            document.getElementById('tv_chart').innerHTML = "";
            new TradingView.widget({
                "autosize": true,
                "symbol": "BINANCE:" + pair,
                "interval": "1",
                "theme": "dark",
                "style": "1",
                "locale": "ar",
                "container_id": "tv_chart",
                "hide_side_toolbar": true,
                "allow_symbol_change": false,
                "studies": [
                    "RSI@tv-basicstudies",
                    "MACD@tv-basicstudies"
                ]
            });
            // كود الـ WebSocket المعتاد لتحديث السعر...
        }

        function showPage(pageId, element) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');
            if(pageId === 'page-trade') {
                setTimeout(() => { changePair(document.getElementById('pairSelector').value); }, 100);
            }
        }

        function handleAuth() {
            document.getElementById('auth-screen').style.display = 'none';
            changePair("BTCUSDT");
        }
    </script>
</body>
</html>
